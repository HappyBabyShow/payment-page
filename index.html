<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Покупка билета — Пенная вечеринка</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .ticket-form { max-width: 400px; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
    .ticket-info { margin-top: 10px; color: #555; }
    .payment-buttons { margin-top: 10px; }
    button { margin-right: 10px; padding: 5px 10px; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check-compat.js"></script>
</head>
<body>
  <h1>Покупка билета на пенную вечеринку</h1>

  <!-- Шаг 1: Город -->
  <label for="city">Выберите город:</label>
  <select id="city" onchange="updateDates()">
    <option value="">-- Выберите --</option>
    <option value="Порту">Порту</option>
    <option value="Лиссабон">Лиссабон</option>
    <option value="Алгарве">Алгарве</option>
  </select>

  <!-- Шаг 2: Дата и время -->
  <div id="dateSection" style="display:none;">
    <p><strong>Дата:</strong></p>
    <select id="eventDate"></select>
    <p><strong>Время:</strong> 15:00</p>

    <!-- Шаг 3: Тип билета и количество -->
    <p><strong>Выберите тип билета:</strong></p>
    <input type="radio" name="ticketType" value="standard" onclick="updateTicketInfo()"> Стандарт — 30€<br>
    <small>Включает: попкорн, сладкая вата, игры и участие в пене</small><br><br>
    <input type="radio" name="ticketType" value="family" onclick="updateTicketInfo()"> Семейный — 70€<br>
    <small>Включает: всё из стандарта + отдельное место со шведским столом и батутом</small><br>
    <div id="quantitySection" style="display:none;">
      <label for="ticketQuantity">Количество:</label>
      <select id="ticketQuantity" onchange="updateTicketInfo()">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
      <div id="ticketAvailability" class="ticket-info"></div>
    </div>

    <!-- Шаг 4: Дополнительная опция -->
    <div id="extrasSection" style="display:none;">
      <p>Добавить шведский стол и батут за 15€?</p>
      <input type="checkbox" id="addExtras">
    </div>

    <!-- Шаг 5: Адрес и карта -->
    <div id="addressSection" style="display:none;">
      <p><strong>Адрес мероприятия:</strong></p>
      <div id="addressText"></div>
      <a id="mapLink" href="#" target="_blank">Открыть в Google Картах</a>
    </div>

    <!-- Кнопки оплаты -->
    <div id="paymentButtons" class="payment-buttons" style="display:none;">
      <button id="payCard" style="background: gray;" onclick="buyTickets('card')">Оплатить картой</button>
      <button id="payPaypal" style="background: gray;" onclick="buyTickets('paypal')">Оплатить PayPal</button>
      <button id="payCash" style="background: gray;" onclick="buyTickets('cash')">Оплатить наличными</button>
    </div>
  </div>

  <script>
    // Твой реальный firebaseConfig
    const firebaseConfig = {
      apiKey: "AIzaSyAmTFbs5fX2r-y7NnHOSWz6lC9wGOW9cPs",
      authDomain: "foam-party-tickets-980c1.firebaseapp.com",
      databaseURL: "https://foam-party-tickets-980c1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "foam-party-tickets-980c1",
      storageBucket: "foam-party-tickets-980c1.firebasestorage.app",
      messagingSenderId: "65345044953",
      appId: "1:65345044953:web:fb02ce3901f9d4e684d9c8"
    };

    // Инициализация Firebase
    const app = initializeApp(firebaseConfig);

    // Активация App Check
    const appCheck = firebase.appCheck();
    appCheck.activate('6LewxGcrAAAAAEzqFq67oZepY8fi9AcqTVYo-GcM', true);

    // Инициализация Realtime Database
    const db = firebase.database();

    // Инициализация ticketLimits
    const initialTicketLimits = {
      standard: 100,
      family: 50,
      total: 150
    };

    function initializeTicketLimits() {
      const ticketLimitsRef = db.ref('ticketLimits');
      ticketLimitsRef.once('value', (snapshot) => {
        if (!snapshot.exists()) {
          ticketLimitsRef.set(initialTicketLimits).then(() => {
            console.log('ticketLimits успешно инициализированы!');
          }).catch((error) => {
            console.error('Ошибка инициализации:', error);
          });
        }
      });
    }

    function updateDates() {
      const city = document.getElementById("city").value;
      const dateSelect = document.getElementById("eventDate");
      const dateSection = document.getElementById("dateSection");

      dateSelect.innerHTML = "";

      if (!city) {
        dateSection.style.display = "none";
        return;
      }

      let dates = [];
      if (city === "Порту") {
        dates = ["2025-08-23", "2025-08-24"];
      } else if (city === "Алгарве") {
        dates = ["2025-08-28"];
      } else if (city === "Лиссабон") {
        dates = ["2025-08-30"];
      }

      dates.forEach(date => {
        const option = document.createElement("option");
        option.value = date;
        option.text = new Date(date).toLocaleDateString("ru-RU");
        dateSelect.appendChild(option);
      });

      dateSection.style.display = "block";
    }

    function updateTicketInfo() {
      const ticketType = document.querySelector('input[name="ticketType"]:checked')?.value;
      const quantitySection = document.getElementById("quantitySection");
      const extrasSection = document.getElementById("extrasSection");
      const addressSection = document.getElementById("addressSection");
      const paymentButtons = document.getElementById("paymentButtons");

      if (ticketType) {
        quantitySection.style.display = "block";
        extrasSection.style.display = ticketType === "standard" ? "block" : "none";
        showAddress();
        updateAvailability();
      } else {
        quantitySection.style.display = "none";
        extrasSection.style.display = "none";
        addressSection.style.display = "none";
        paymentButtons.style.display = "none";
      }
    }

    function updateAvailability() {
      const ticketType = document.querySelector('input[name="ticketType"]:checked')?.value;
      const ticketQuantity = parseInt(document.getElementById("ticketQuantity").value);
      const ticketAvailability = document.getElementById("ticketAvailability");
      const paymentButtons = document.getElementById("paymentButtons");

      if (ticketType) {
        const ticketLimitsRef = db.ref('ticketLimits');
        ticketLimitsRef.once('value', (snapshot) => {
          const limits = snapshot.val() || initialTicketLimits;
          const available = limits[ticketType];
          if (ticketQuantity <= available) {
            ticketAvailability.innerText = `Доступно: ${available} билетов.`;
            paymentButtons.style.display = "block";
            document.getElementById("payCard").style.background = "green";
            document.getElementById("payPaypal").style.background = "green";
            document.getElementById("payCash").style.background = "green";
            document.getElementById("payCard").disabled = false;
            document.getElementById("payPaypal").disabled = false;
            document.getElementById("payCash").disabled = false;
          } else {
            ticketAvailability.innerText = `Недостаточно билетов. Доступно: ${available}.`;
            paymentButtons.style.display = "block";
            document.getElementById("payCard").style.background = "gray";
            document.getElementById("payPaypal").style.background = "gray";
            document.getElementById("payCash").style.background = "gray";
            document.getElementById("payCard").disabled = true;
            document.getElementById("payPaypal").disabled = true;
            document.getElementById("payCash").disabled = true;
          }
        }).catch((error) => {
          console.error('Ошибка проверки доступности:', error);
          ticketAvailability.innerText = 'Ошибка загрузки данных.';
          paymentButtons.style.display = "none";
        });
      }
    }

    function showAddress() {
      const city = document.getElementById("city").value;
      const addressText = {
        "Порту": "R. do Cerro 396, 4405-736 Vila Nova de Gaia",
        "Лиссабон": "Praia de Carcavelos, Лиссабон",
        "Алгарве": "Praia da Rocha, Алгарве"
      };
      const mapLinks = {
        "Порту": "https://maps.app.goo.gl/qwegq9geA1fnfzcT8",
        "Лиссабон": "https://maps.google.com/?q=Praia+de+Carcavelos+Lisboa",
        "Алгарве": "https://maps.google.com/?q=Praia+da+Rocha+Algarve"
      };

      const addressSection = document.getElementById("addressSection");
      const paymentButtons = document.getElementById("paymentButtons");
      if (city) {
        document.getElementById("addressText").innerText = addressText[city];
        document.getElementById("mapLink").href = mapLinks[city];
        addressSection.style.display = "block";
        paymentButtons.style.display = "block"; // Показываем кнопки при выборе адреса
      } else {
        addressSection.style.display = "none";
        paymentButtons.style.display = "none";
      }
    }

    function buyTickets(paymentMethod) {
      const ticketType = document.querySelector('input[name="ticketType"]:checked')?.value;
      const ticketQuantity = parseInt(document.getElementById("ticketQuantity").value);
      const ticketLimitsRef = db.ref('ticketLimits');
      const payCard = document.getElementById("payCard");
      const payPaypal = document.getElementById("payPaypal");
      const payCash = document.getElementById("payCash");

      if (!ticketType || !ticketQuantity) {
        alert("Выберите тип и количество билетов!");
        return;
      }

      // Отключаем все кнопки во время операции
      payCard.disabled = true;
      payPaypal.disabled = true;
      payCash.disabled = true;
      payCard.style.background = "gray";
      payPaypal.style.background = "gray";
      payCash.style.background = "gray";

      ticketLimitsRef.once('value', (snapshot) => {
        const limits = snapshot.val() || initialTicketLimits;
        const available = limits[ticketType];

        if (ticketQuantity <= available) {
          const newLimit = available - ticketQuantity;
          const newTotal = limits.total - ticketQuantity;
          ticketLimitsRef.update({ [ticketType]: newLimit, total: newTotal }).then(() => {
            console.log(`Успешно куплено ${ticketQuantity} билет(ов) типа ${ticketType} через ${paymentMethod}`);
            alert(`Успешно куплено ${ticketQuantity} билет(ов) типа ${ticketType} через ${paymentMethod}! Остаток: ${newLimit}`);
            updateAvailability();
          }).catch((error) => {
            console.error('Ошибка покупки:', error);
            alert("Ошибка при покупке. Попробуйте снова.");
            // Восстанавливаем кнопки
            payCard.disabled = false;
            payPaypal.disabled = false;
            payCash.disabled = false;
            if (ticketQuantity <= available) {
              payCard.style.background = "green";
              payPaypal.style.background = "green";
              payCash.style.background = "green";
            }
          });
        } else {
          alert(`Недостаточно билетов. Доступно: ${available}.`);
          // Восстанавливаем кнопки
          payCard.disabled = false;
          payPaypal.disabled = false;
          payCash.disabled = false;
          if (ticketQuantity <= available) {
            payCard.style.background = "green";
            payPaypal.style.background = "green";
            payCash.style.background = "green";
          }
        }
      }).catch((error) => {
        console.error('Ошибка доступа к базе:', error);
        alert("Ошибка подключения к базе данных.");
        // Восстанавливаем кнопки
        payCard.disabled = false;
        payPaypal.disabled = false;
        payCash.disabled = false;
        payCard.style.background = "green";
        payPaypal.style.background = "green";
        payCash.style.background = "green";
      });
    }

    // Инициализация при загрузке
    initializeTicketLimits();
  </script>
</body>
</html>