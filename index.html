<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Покупка билета — Пенная вечеринка</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .ticket-form { max-width: 400px; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
    .payment-buttons { margin-top: 10px; }
    .crypto-button img { width: 200px; margin: 10px 0; }
    button { padding: 10px; margin: 5px; background: green; color: white; border: none; cursor: pointer; }
    button:disabled { background: gray; cursor: not-allowed; }
    #stripeButtonContainer { margin-top: 10px; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check-compat.js"></script>
  <script async src="https://js.stripe.com/v3/buy-button.js"></script>
</head>
<body>
  <h1>Покупка билета на пенную вечеринку</h1>

  <label for="city">Выберите город:</label>
  <select id="city" onchange="updateDates()">
    <option value="">-- Выберите --</option>
    <option value="Порту">Порту</option>
    <option value="Лиссабон">Лиссабон</option>
    <option value="Алгарве">Алгарве</option>
  </select>

  <div id="dateSection" style="display:none;">
    <p><strong>Дата:</strong></p>
    <select id="eventDate" onchange="updateTicketInfo()"></select>
    <p><strong>Время:</strong> 15:00</p>

    <p><strong>Выберите тип билета:</strong></p>
    <input type="radio" name="ticketType" value="standard" onclick="updateTicketInfo()"> Стандарт — 30€<br>
    <small>Включает: попкорн, сладкая вата, игры и участие в пене</small><br><br>
    <input type="radio" name="ticketType" value="standardPlus" onclick="updateTicketInfo()"> Стандарт+ — 45€<br>
    <small>Включает: всё из стандарта + шведский стол и батут</small><br><br>
    <input type="radio" name="ticketType" value="family" onclick="updateTicketInfo()"> Семейный — 70€<br>
    <small>Включает: всё из стандарта + отдельное место со шведским столом и батутом</small><br>
    <div id="ticketAvailability" class="ticket-info"></div>

    <div id="addressSection" style="display:none;">
      <p><strong>Адрес мероприятия:</strong></p>
      <div id="addressText"></div>
      <a id="mapLink" href="#" target="_blank">Открыть в Google Картах</a>
    </div>

    <div id="paymentButtons" class="payment-buttons" style="display:none;">
      <h3>Выберите способ оплаты:</h3>
      <button id="payFiat" onclick="showStripePayment()">Оплатить картой (Stripe)</button>
      <button id="payCrypto" onclick="showCryptoPayment()">Оплатить криптовалютой (USDT/USDC)</button>
    </div>

    <div id="stripeButtonContainer" style="display:none;"></div>
    <div id="cryptoPaymentContainer" style="display:none;" class="crypto-button"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAmTFbs5fX2r-y7NnHOSWz6lC9wGOW9cPs",
      authDomain: "foam-party-tickets-980c1.firebaseapp.com",
      databaseURL: "https://foam-party-tickets-980c1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "foam-party-tickets-980c1",
      storageBucket: "foam-party-tickets-980c1.appspot.com",
      messagingSenderId: "65345044953",
      appId: "1:65345044953:web:fb02ce3901f9d4e684d9c8"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const appCheck = firebase.appCheck();
    appCheck.activate('6LewxGcrAAAAAEzqFq67oZepY8fi9AcqTVYo-GcM', true);
    const db = firebase.database();

    function initializeTicketLimits() {
      const ticketLimitsRef = db.ref('ticketLimits');
      ticketLimitsRef.once('value', (snapshot) => {
        if (!snapshot.exists()) {
          const newLimits = {
            "Порту": {
              "2025-08-23": { standard: 30, standardPlus: 20, family: 20, total: 70 },
              "2025-08-24": { standard: 30, standardPlus: 20, family: 20, total: 70 }
            },
            "Алгарве": {
              "2025-08-28": { standard: 30, standardPlus: 20, family: 20, total: 70 }
            },
            "Лиссабон": {
              "2025-08-30": { standard: 30, standardPlus: 20, family: 20, total: 70 }
            }
          };
          ticketLimitsRef.set(newLimits).then(() => {
            console.log('ticketLimits успешно инициализированы:', newLimits);
          }).catch((error) => {
            console.error('Ошибка инициализации:', error);
          });
        } else {
          console.log('Текущие ticketLimits:', snapshot.val());
        }
      });
    }

    function updateDates() {
      const city = document.getElementById("city").value;
      const dateSelect = document.getElementById("eventDate");
      const dateSection = document.getElementById("dateSection");

      dateSelect.innerHTML = "";
      if (!city) {
        dateSection.style.display = "none";
        return;
      }

      let dates = [];
      if (city === "Порту") {
        dates = ["2025-08-23", "2025-08-24"];
      } else if (city === "Алгарве") {
        dates = ["2025-08-28"];
      } else if (city === "Лиссабон") {
        dates = ["2025-08-30"];
      }

      dates.forEach(date => {
        const option = document.createElement("option");
        option.value = date;
        option.text = new Date(date).toLocaleDateString("ru-RU");
        dateSelect.appendChild(option);
      });

      dateSection.style.display = "block";
      updateTicketInfo();
    }

    function updateTicketInfo() {
      const city = document.getElementById("city").value;
      const eventDate = document.getElementById("eventDate").value;
      const ticketType = document.querySelector('input[name="ticketType"]:checked')?.value;
      const ticketAvailability = document.getElementById("ticketAvailability");
      const paymentButtons = document.getElementById("paymentButtons");
      const stripeButtonContainer = document.getElementById("stripeButtonContainer");
      const cryptoPaymentContainer = document.getElementById("cryptoPaymentContainer");

      if (ticketType && city && eventDate) {
        const path = `ticketLimits/${city}/${eventDate}`;
        const ticketLimitsRef = db.ref(path);

        ticketLimitsRef.once('value', (snapshot) => {
          const limits = snapshot.val();
          if (!limits) {
            ticketAvailability.innerText = 'Нет информации о билетах.';
            paymentButtons.style.display = "none";
            return;
          }
          const available = limits[ticketType] || 0;
          if (available >= 1) {
            ticketAvailability.innerText = `Доступно: ${available} билетов.`;
            paymentButtons.style.display = "block";
          } else {
            ticketAvailability.innerText = `Билеты закончились.`;
            paymentButtons.style.display = "none";
          }
        }).catch((error) => {
          console.error('Ошибка Firebase:', error);
          ticketAvailability.innerText = 'Ошибка загрузки данных.';
          paymentButtons.style.display = "none";
        });

        showAddress();
      } else {
        ticketAvailability.innerText = "";
        paymentButtons.style.display = "none";
        stripeButtonContainer.style.display = "none";
        cryptoPaymentContainer.style.display = "none";
      }
    }

    function showAddress() {
      const city = document.getElementById("city").value;
      const addressText = {
        "Порту": "R. do Cerro 396, 4405-736 Vila Nova de Gaia",
        "Лиссабон": "Praia de Carcavelos, Лиссабон",
        "Алгарве": "Praia da Rocha, Алгарве"
      };
      const mapLinks = {
        "Порту": "https://maps.app.goo.gl/qwegq9geA1fnfzcT8",
        "Лиссабон": "https://maps.google.com/?q=Praia+de+Carcavelos+Lisboa",
        "Алгарве": "https://maps.google.com/?q=Praia+da+Rocha+Algarve"
      };

      const addressSection = document.getElementById("addressSection");
      if (city) {
        document.getElementById("addressText").innerText = addressText[city];
        document.getElementById("mapLink").href = mapLinks[city];
        addressSection.style.display = "block";
      } else {
        addressSection.style.display = "none";
      }
    }

    function showStripePayment() {
      const ticketType = document.querySelector('input[name="ticketType"]:checked')?.value;
      const stripeButtonContainer = document.getElementById("stripeButtonContainer");
      const cryptoPaymentContainer = document.getElementById("cryptoPaymentContainer");

      if (!ticketType) {
        alert("Выберите тип билета!");
        return;
      }

      stripeButtonContainer.innerHTML = '';
      cryptoPaymentContainer.style.display = "none";

      let buyButtonId;
      const publishableKey = "pk_test_51RahBHLWvpIFJx0Gmz0AVyfPy3cWtaPrPMYeU8UqU9jbiwJkszhjOqeA1P7W95jpMYkxb4sofIkwpVZUItiq78jn00a6DSXXvF"; // Общий ключ

      if (ticketType === "standard") {
        buyButtonId = "buy_btn_1Rgv1OLWvpIFJx0Gcave0q9s";
      } else if (ticketType === "standardPlus") {
        buyButtonId = "buy_btn_1Rgv2lLWvpIFJx0GYmVAEhyL";
      } else if (ticketType === "family") {
        buyButtonId = "buy_btn_1Rgv3SLWvpIFJx0Gnh6ipiDU";
      }

      const stripeButton = document.createElement('stripe-buy-button');
      stripeButton.setAttribute('buy-button-id', buyButtonId);
      stripeButton.setAttribute('publishable-key', publishableKey);
      stripeButtonContainer.appendChild(stripeButton);
      stripeButtonContainer.style.display = "block";
    }

    function showCryptoPayment() {
      const ticketType = document.querySelector('input[name="ticketType"]:checked')?.value;
      const cryptoPaymentContainer = document.getElementById("cryptoPaymentContainer");
      const stripeButtonContainer = document.getElementById("stripeButtonContainer");

      if (!ticketType) {
        alert("Выберите тип билета!");
        return;
      }

      cryptoPaymentContainer.innerHTML = '';
      stripeButtonContainer.style.display = "none";

      let paymentLink;
      if (ticketType === "standard") {
        paymentLink = "https://nowpayments.io/payment/?iid=4948781828&source=button";
      } else if (ticketType === "standardPlus") {
        paymentLink = "https://nowpayments.io/payment/?iid=5115039554&source=button";
      } else if (ticketType === "family") {
        paymentLink = "https://nowpayments.io/payment/?iid=6307653663&source=button";
      }

      const cryptoButton = document.createElement('a');
      cryptoButton.href = paymentLink;
      cryptoButton.target = "_blank";
      cryptoButton.rel = "noreferrer noopener";
      const img = document.createElement('img');
      img.src = "https://nowpayments.io/images/embeds/payment-button-white.svg";
      img.alt = "Cryptocurrency & Bitcoin payment button by NOWPayments";
      cryptoButton.appendChild(img);
      cryptoPaymentContainer.appendChild(cryptoButton);
      cryptoPaymentContainer.style.display = "block";
    }

    initializeTicketLimits();
  </script>
</body>
</html>