<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Покупка билета — Пенная вечеринка</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .ticket-form { max-width: 400px; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
    .payment-buttons { margin-top: 10px; }
    .crypto-button img { width: 200px; margin: 10px 0; }
    button { padding: 10px; margin: 5px; background: green; color: white; border: none; cursor: pointer; }
    button:disabled { background: gray; cursor: not-allowed; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check-compat.js"></script>
</head>
<body>
  <h1>Покупка билета на пенную вечеринку</h1>

  <!-- Шаг 1: Город -->
  <label for="city">Выберите город:</label>
  <select id="city" onchange="updateDates()">
    <option value="">-- Выберите --</option>
    <option value="Порту">Порту</option>
    <option value="Лиссабон">Лиссабон</option>
    <option value="Алгарве">Алгарве</option>
  </select>

  <!-- Шаг 2: Дата и время -->
  <div id="dateSection" style="display:none;">
    <p><strong>Дата:</strong></p>
    <select id="eventDate"></select>
    <p><strong>Время:</strong> 15:00</p>

    <!-- Шаг 3: Тип билета и количество -->
    <p><strong>Выберите тип билета:</strong></p>
    <input type="radio" name="ticketType" value="standard" onclick="updateTicketInfo()"> Стандарт — 30€<br>
    <small>Включает: попкорн, сладкая вата, игры и участие в пене</small><br><br>
    <input type="radio" name="ticketType" value="standardPlus" onclick="updateTicketInfo()"> Стандарт+ — 45€<br>
    <small>Включает: всё из стандарта + шведский стол и батут</small><br><br>
    <input type="radio" name="ticketType" value="family" onclick="updateTicketInfo()"> Семейный — 70€<br>
    <small>Включает: всё из стандарта + отдельное место со шведским столом и батутом</small><br>
    <div id="quantitySection" style="display:none;">
      <label for="ticketQuantity">Количество:</label>
      <select id="ticketQuantity" onchange="updateTicketInfo()">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
      <div id="ticketAvailability" class="ticket-info"></div>
    </div>

    <!-- Шаг 4: Адрес и карта -->
    <div id="addressSection" style="display:none;">
      <p><strong>Адрес мероприятия:</strong></p>
      <div id="addressText"></div>
      <a id="mapLink" href="#" target="_blank">Открыть в Google Картах</a>
    </div>

    <!-- Кнопки оплаты -->
    <div id="paymentButtons" class="payment-buttons" style="display:none;">
      <h3>Выберите способ оплаты:</h3>
      <button id="payFiat" onclick="buyTickets('fiat')">Оплатить картой (Stripe)</button>
      <button id="payCrypto" onclick="showCryptoPayment()">Оплатить криптовалютой (USDT/USDC)</button>
    </div>

    <!-- Контейнер для кнопки Stripe или крипто-оплаты -->
    <div id="stripeButtonContainer" style="display:none;"></div>
    <div id="cryptoPaymentContainer" style="display:none;" class="crypto-button">
      <!-- Кнопки крипто-оплаты добавляются динамически -->
    </div>
  </div>

  <script>
    // Твой реальный firebaseConfig
    const firebaseConfig = {
      apiKey: "AIzaSyAmTFbs5fX2r-y7NnHOSWz6lC9wGOW9cPs",
      authDomain: "foam-party-tickets-980c1.firebaseapp.com",
      databaseURL: "https://foam-party-tickets-980c1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "foam-party-tickets-980c1",
      storageBucket: "foam-party-tickets-980c1.firebasestorage.app",
      messagingSenderId: "65345044953",
      appId: "1:65345044953:web:fb02ce3901f9d4e684d9c8"
    };

    // Инициализация Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const appCheck = firebase.appCheck();
    appCheck.activate('6LewxGcrAAAAAEzqFq67oZepY8fi9AcqTVYo-GcM', true);
    const db = firebase.database();

    // Инициализация ticketLimits
    const initialTicketLimits = {
      standard: 100,
      standardPlus: 50,
      family: 30,
      total: 180
    };

    function initializeTicketLimits() {
      const ticketLimitsRef = db.ref('ticketLimits');
      ticketLimitsRef.once('value', (snapshot) => {
        if (!snapshot.exists()) {
          ticketLimitsRef.set(initialTicketLimits).then(() => {
            console.log('ticketLimits успешно инициализированы!');
          }).catch((error) => {
            console.error('Ошибка инициализации:', error);
          });
        }
      });
    }

    function updateDates() {
      const city = document.getElementById("city").value;
      const dateSelect = document.getElementById("eventDate");
      const dateSection = document.getElementById("dateSection");

      dateSelect.innerHTML = "";

      if (!city) {
        dateSection.style.display = "none";
        return;
      }

      let dates = [];
      if (city === "Порту") {
        dates = ["2025-08-23", "2025-08-24"];
      } else if (city === "Алгарве") {
        dates = ["2025-08-28"];
      } else if (city === "Лиссабон") {
        dates = ["2025-08-30"];
      }

      dates.forEach(date => {
        const option = document.createElement("option");
        option.value = date;
        option.text = new Date(date).toLocaleDateString("ru-RU");
        dateSelect.appendChild(option);
      });

      dateSection.style.display = "block";
    }

    function updateTicketInfo() {
      const ticketType = document.querySelector('input[name="ticketType"]:checked')?.value;
      const quantitySection = document.getElementById("quantitySection");
      const paymentButtons = document.getElementById("paymentButtons");
      const stripeButtonContainer = document.getElementById("stripeButtonContainer");
      const cryptoPaymentContainer = document.getElementById("cryptoPaymentContainer");

      if (ticketType) {
        quantitySection.style.display = "block";
        paymentButtons.style.display = "block";
        stripeButtonContainer.style.display = "none";
        cryptoPaymentContainer.style.display = "none";
        showAddress();
        updateAvailability();
      } else {
        quantitySection.style.display = "none";
        paymentButtons.style.display = "none";
        stripeButtonContainer.style.display = "none";
        cryptoPaymentContainer.style.display = "none";
      }
    }

    function updateAvailability() {
      const ticketType = document.querySelector('input[name="ticketType"]:checked')?.value;
      const ticketQuantity = parseInt(document.getElementById("ticketQuantity").value);
      const ticketAvailability = document.getElementById("ticketAvailability");

      if (ticketType) {
        const ticketLimitsRef = db.ref('ticketLimits');
        ticketLimitsRef.once('value', (snapshot) => {
          const limits = snapshot.val() || initialTicketLimits;
          const available = limits[ticketType];
          if (ticketQuantity <= available) {
            ticketAvailability.innerText = `Доступно: ${available} билетов.`;
          } else {
            ticketAvailability.innerText = `Недостаточно билетов. Доступно: ${available}.`;
          }
        }).catch((error) => {
          console.error('Ошибка проверки доступности:', error);
          ticketAvailability.innerText = 'Ошибка загрузки данных.';
        });
      }
    }

    function showAddress() {
      const city = document.getElementById("city").value;
      const addressText = {
        "Порту": "R. do Cerro 396, 4405-736 Vila Nova de Gaia",
        "Лиссабон": "Praia de Carcavelos, Лиссабон",
        "Алгарве": "Praia da Rocha, Алгарве"
      };
      const mapLinks = {
        "Порту": "https://maps.app.goo.gl/qwegq9geA1fnfzcT8",
        "Лиссабон": "https://maps.google.com/?q=Praia+de+Carcavelos+Lisboa",
        "Алгарве": "https://maps.google.com/?q=Praia+da+Rocha+Algarve"
      };

      const addressSection = document.getElementById("addressSection");
      if (city) {
        document.getElementById("addressText").innerText = addressText[city];
        document.getElementById("mapLink").href = mapLinks[city];
        addressSection.style.display = "block";
      } else {
        addressSection.style.display = "none";
      }
    }

    function buyTickets(paymentMethod) {
      const ticketType = document.querySelector('input[name="ticketType"]:checked')?.value;
      const ticketQuantity = parseInt(document.getElementById("ticketQuantity").value);
      const ticketLimitsRef = db.ref('ticketLimits');
      const payFiat = document.getElementById("payFiat");
      const payCrypto = document.getElementById("payCrypto");

      if (!ticketType || !ticketQuantity) {
        alert("Выберите тип и количество билетов!");
        return;
      }

      // Отключаем кнопки во время операции
      payFiat.disabled = true;
      payCrypto.disabled = true;
      payFiat.style.background = "gray";
      payCrypto.style.background = "gray";

      ticketLimitsRef.once('value', (snapshot) => {
        const limits = snapshot.val() || initialTicketLimits;
        const available = limits[ticketType];

        if (ticketQuantity <= available) {
          const newLimit = available - ticketQuantity;
          const newTotal = limits.total - ticketQuantity;
          ticketLimitsRef.update({ [ticketType]: newLimit, total: newTotal }).then(() => {
            console.log(`Успешно куплено ${ticketQuantity} билет(ов) типа ${ticketType} через ${paymentMethod}`);
            alert(`Успешно куплено ${ticketQuantity} билет(ов) типа ${ticketType} через ${paymentMethod}! Остаток: ${newLimit}`);
            updateAvailability();
          }).catch((error) => {
            console.error('Ошибка покупки:', error);
            alert("Ошибка при покупке. Попробуйте снова.");
            payFiat.disabled = false;
            payCrypto.disabled = false;
            if (ticketQuantity <= available) {
              payFiat.style.background = "green";
              payCrypto.style.background = "green";
            }
          });
        } else {
          alert(`Недостаточно билетов. Доступно: ${available}.`);
          payFiat.disabled = false;
          payCrypto.disabled = false;
          if (ticketQuantity <= available) {
            payFiat.style.background = "green";
            payCrypto.style.background = "green";
          }
        }
      }).catch((error) => {
        console.error('Ошибка доступа к базе:', error);
        alert("Ошибка подключения к базе данных.");
        payFiat.disabled = false;
        payCrypto.disabled = false;
        payFiat.style.background = "green";
        payCrypto.style.background = "green";
      });
    }

    function showCryptoPayment() {
      const ticketType = document.querySelector('input[name="ticketType"]:checked')?.value;
      const cryptoPaymentContainer = document.getElementById("cryptoPaymentContainer");
      cryptoPaymentContainer.innerHTML = '';

      let paymentLink;
      if (ticketType === "standard") {
        paymentLink = "https://nowpayments.io/payment/?iid=4948781828&source=button";
      } else if (ticketType === "standardPlus") {
        paymentLink = "https://nowpayments.io/payment/?iid=5115039554&source=button";
      } else if (ticketType === "family") {
        paymentLink = "https://nowpayments.io/payment/?iid=6307653663&source=button";
      }

      const cryptoButton = document.createElement('a');
      cryptoButton.href = paymentLink;
      cryptoButton.target = "_blank";
      cryptoButton.rel = "noreferrer noopener";
      const img = document.createElement('img');
      img.src = "https://nowpayments.io/images/embeds/payment-button-white.svg";
      img.alt = "Cryptocurrency & Bitcoin payment button by NOWPayments";
      cryptoButton.appendChild(img);
      cryptoPaymentContainer.appendChild(cryptoButton);
      cryptoPaymentContainer.style.display = "block";
    }

    // Инициализация при загрузке
    initializeTicketLimits();
  </script>
</body>
</html>