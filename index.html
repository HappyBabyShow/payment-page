<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Покупка билета — Пенная вечеринка</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .ticket-form { max-width: 400px; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
    .ticket-info { margin-top: 10px; color: #555; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check-compat.js"></script>
</head>
<body>
  <h1>Покупка билета на пенную вечеринку</h1>

  <!-- Шаг 1: Город -->
  <label for="city">Выберите город:</label>
  <select id="city" onchange="updateDates()">
    <option value="">-- Выберите --</option>
    <option value="Порту">Порту</option>
    <option value="Лиссабон">Лиссабон</option>
    <option value="Алгарве">Алгарве</option>
  </select>

  <!-- Шаг 2: Дата и время -->
  <div id="dateSection" style="display:none;">
    <p><strong>Дата:</strong></p>
    <select id="eventDate"></select>
    <p><strong>Время:</strong> 15:00</p>

    <!-- Шаг 3: Тип билета и количество -->
    <p><strong>Выберите тип билета:</strong></p>
    <input type="radio" name="ticketType" value="standard" onclick="updateTicketInfo()"> Стандарт — 30€<br>
    <small>Включает: билет на одного ребенка попкорн, сладкая вата, игры и участие в пене</small><br><br>
    <input type="radio" name="ticketType" value="family" onclick="updateTicketInfo()"> Семейный — 70€<br>
    <small>Включает: всё из стандарта + один взрослый или ребенок, доступ к шведскиму столу и батуту</small><br>
    <div id="quantitySection" style="display:none;">
      <label for="ticketQuantity">Количество:</label>
      <select id="ticketQuantity" onchange="updateTicketInfo()">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
      <div id="ticketAvailability" class="ticket-info"></div>
    </div>

    <!-- Шаг 4: Дополнительная опция -->
    <div id="extrasSection" style="display:none;">
      <p>Добавить шведский стол и батут за 15€?</p>
      <input type="checkbox" id="addExtras">
    </div>

    <!-- Шаг 5: Адрес и карта -->
    <div id="addressSection" style="display:none;">
      <p><strong>Адрес мероприятия:</strong></p>
      <div id="addressText"></div>
      <a id="mapLink" href="#" target="_blank">Открыть в Google Картах</a>
    </div>

    <!-- Кнопка оплаты -->
    <button id="payButton" style="display:none; background: gray;" onclick="buyTickets()">Оплатить</button>
  </div>

  <script>
    // Твой реальный firebaseConfig
    const firebaseConfig = {
      apiKey: "AIzaSyAmTFbs5fX2r-y7NnHOSWz6lC9wGOW9cPs",
      authDomain: "foam-party-tickets-980c1.firebaseapp.com",
      databaseURL: "https://foam-party-tickets-980c1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "foam-party-tickets-980c1",
      storageBucket: "foam-party-tickets-980c1.firebasestorage.app",
      messagingSenderId: "65345044953",
      appId: "1:65345044953:web:fb02ce3901f9d4e684d9c8"
    };

    // Инициализация Firebase
    const app = initializeApp(firebaseConfig);

    // Активация App Check
    const appCheck = firebase.appCheck();
    appCheck.activate('6LewxGcrAAAAAEzqFq67oZepY8fi9AcqTVYo-GcM', true);

    // Инициализация Realtime Database
    const db = firebase.database();

    // Инициализация ticketLimits
    const initialTicketLimits = {
      standard: 100,
      family: 50,
      total: 150
    };

    function initializeTicketLimits() {
      const ticketLimitsRef = db.ref('ticketLimits');
      ticketLimitsRef.once('value', (snapshot) => {
        if (!snapshot.exists()) {
          ticketLimitsRef.set(initialTicketLimits).then(() => {
            console.log('ticketLimits успешно инициализированы!');
          }).catch((error) => {
            console.error('Ошибка инициализации:', error);
          });
        }
      });
    }

    function updateDates() {
      const city = document.getElementById("city").value;
      const dateSelect = document.getElementById("eventDate");
      const dateSection = document.getElementById("dateSection");

      dateSelect.innerHTML = "";

      if (!city) {
        dateSection.style.display = "none";
        return;
      }

      let dates = [];
      if (city === "Порту") {
        dates = ["2025-08-23", "2025-08-24"];
      } else if (city === "Алгарве") {
        dates = ["2025-08-28"];
      } else if (city === "Лиссабон") {
        dates = ["2025-08-30"];
      }

      dates.forEach(date => {
        const option = document.createElement("option");
        option.value = date;
        option.text = new Date(date).toLocaleDateString("ru-RU");
        dateSelect.appendChild(option);
      });

      dateSection.style.display = "block";
    }

    function updateTicketInfo() {
      const ticketType = document.querySelector('input[name="ticketType"]:checked')?.value;
      const quantitySection = document.getElementById("quantitySection");
      const extrasSection = document.getElementById("extrasSection");
      const addressSection = document.getElementById("addressSection");
      const payButton = document.getElementById("payButton");

      if (ticketType) {
        quantitySection.style.display = "block";
        extrasSection.style.display = ticketType === "standard" ? "block" : "none";
        showAddress();
        updateAvailability();
      } else {
        quantitySection.style.display = "none";
        extrasSection.style.display = "none";
        addressSection.style.display = "none";
        payButton.style.display = "none";
      }
    }

    function updateAvailability() {
      const ticketType = document.querySelector('input[name="ticketType"]:checked')?.value;
      const ticketQuantity = parseInt(document.getElementById("ticketQuantity").value);
      const ticketAvailability = document.getElementById("ticketAvailability");

      if (ticketType) {
        const ticketLimitsRef = db.ref('ticketLimits');
        ticketLimitsRef.once('value', (snapshot) => {
          const limits = snapshot.val() || initialTicketLimits;
          const available = limits[ticketType];
          if (ticketQuantity <= available) {
            ticketAvailability.innerText = `Доступно: ${available} билетов.`;
            document.getElementById("payButton").style.background = "green";
          } else {
            ticketAvailability.innerText = `Недостаточно билетов. Доступно: ${available}.`;
            document.getElementById("payButton").style.background = "gray";
          }
        });
      }
    }

    function showAddress() {
      const city = document.getElementById("city").value;
      const addressText = {
        "Порту": "R. do Cerro 396, 4405-736 Vila Nova de Gaia",
        "Лиссабон": "Praia de Carcavelos, Лиссабон",
        "Алгарве": "Praia da Rocha, Алгарве"
      };
      const mapLinks = {
        "Порту": "https://maps.app.goo.gl/qwegq9geA1fnfzcT8",
        "Лиссабон": "https://maps.google.com/?q=Praia+de+Carcavelos+Lisboa",
        "Алгарве": "https://maps.google.com/?q=Praia+da+Rocha+Algarve"
      };

      const addressSection = document.getElementById("addressSection");
      const payButton = document.getElementById("payButton");
      if (city) {
        document.getElementById("addressText").innerText = addressText[city];
        document.getElementById("mapLink").href = mapLinks[city];
        addressSection.style.display = "block";
        payButton.style.display = "inline-block";
      } else {
        addressSection.style.display = "none";
        payButton.style.display = "none";
      }
    }

    function buyTickets() {
      const ticketType = document.querySelector('input[name="ticketType"]:checked')?.value;
      const ticketQuantity = parseInt(document.getElementById("ticketQuantity").value);
      const ticketLimitsRef = db.ref('ticketLimits');

      if (!ticketType || !ticketQuantity) {
        alert("Выберите тип и количество билетов!");
        return;
      }

      ticketLimitsRef.once('value', (snapshot) => {
        const limits = snapshot.val() || initialTicketLimits;
        const available = limits[ticketType];

        if (ticketQuantity <= available) {
          const newLimit = available - ticketQuantity;
          const newTotal = limits.total - ticketQuantity;
          ticketLimitsRef.update({ [ticketType]: newLimit, total: newTotal }).then(() => {
            alert(`Успешно куплено ${ticketQuantity} билет(ов) типа ${ticketType}! Остаток: ${newLimit}`);
            updateAvailability();
          }).catch((error) => {
            console.error('Ошибка покупки:', error);
            alert("Ошибка при покупке. Попробуйте снова.");
          });
        } else {
          alert(`Недостаточно билетов. Доступно: ${available}.`);
        }
      });
    }

    // Инициализация при загрузке
    initializeTicketLimits();
  </script>
</body>
</html>