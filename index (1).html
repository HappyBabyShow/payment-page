<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Покупка билета — Пенная вечеринка</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .ticket-form { max-width: 400px; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
    .payment-buttons { margin-top: 10px; }
    .crypto-button img { width: 200px; margin: 10px 0; }
    button { padding: 10px; margin: 5px; background: green; color: white; border: none; cursor: pointer; }
    button:disabled { background: gray; cursor: not-allowed; }
    #stripeButtonContainer, #cryptoPaymentContainer { margin-top: 10px; }
    #outOfStockMessage { color: red; display: none; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <!-- Подключение Stripe Buy Button -->
  <script async src="https://js.stripe.com/v3/buy-button.js"></script>
  <!-- Подключение EmailJS для уведомлений -->
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
</head>
<body>
  <h1>Покупка билета на пенную вечеринка</h1>

  <!-- Шаг 1: Город -->
  <label for="city">Выберите город:</label>
  <select id="city" onchange="updateDates()">
    <option value="">-- Выберите --</option>
    <option value="Порту">Порту</option>
    <option value="Лиссабон">Лиссабон</option>
    <option value="Алгарве">Алгарве</option>
  </select>

  <!-- Шаг 2: Дата и время -->
  <div id="dateSection" style="display:none;">
    <p><strong>Дата:</strong></p>
    <select id="eventDate"></select>
    <p><strong>Время:</strong> 15:00</p>

    <!-- Шаг 3: Тип билета и количество -->
    <p><strong>Выберите тип билета:</strong></p>
    <input type="radio" name="ticketType" value="standard" onclick="updateTicketInfo()"> Стандарт — 30€<br>
    <small>Включает: попкорн, сладкая вата, игры и участие в пене</small><br><br>
    <input type="radio" name="ticketType" value="standardPlus" onclick="updateTicketInfo()"> Стандарт+ — 45€<br>
    <small>Включает: всё из стандарта + шведский стол и батут</small><br><br>
    <input type="radio" name="ticketType" value="family" onclick="updateTicketInfo()"> Семейный — 70€<br>
    <small>Включает: всё из стандарта + отдельное место со шведским столом и батутом</small><br>
    <div id="quantitySection" style="display:none;">
      <label for="ticketQuantity">Количество:</label>
      <select id="ticketQuantity" onchange="updateTicketInfo()">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
      <div id="ticketAvailability" class="ticket-info"></div>
      <div id="outOfStockMessage">Билеты закончились!</div>
    </div>

    <!-- Шаг 4: Адрес и карта -->
    <div id="addressSection" style="display:none;">
      <p><strong>Адрес мероприятия:</strong></p>
      <div id="addressText"></div>
      <a id="mapLink" href="#" target="_blank">Открыть в Google Картах</a>
    </div>

    <!-- Кнопки выбора способа оплаты -->
    <div id="paymentButtons" class="payment-buttons" style="display:none;">
      <h3>Выберите способ оплаты:</h3>
      <button id="payFiat" onclick="showStripePayment()">Оплатить картой (Stripe)</button>
      <button id="payCrypto" onclick="showCryptoPayment()">Оплатить криптовалютой (USDT/USDC)</button>
    </div>

    <!-- Контейнеры для кнопок оплаты -->
    <div id="stripeButtonContainer" style="display:none;"></div>
    <div id="cryptoPaymentContainer" style="display:none;" class="crypto-button">
      <!-- Кнопки крипто-оплаты добавляются динамически -->
    </div>
  </div>

  <script>
    // Твой реальный firebaseConfig
    const firebaseConfig = {
      apiKey: "AIzaSyAmTFbs5fX2r-y7NnHOSWz6lC9wGOW9cPs",
      authDomain: "foam-party-tickets-980c1.firebaseapp.com",
      databaseURL: "https://foam-party-tickets-980c1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "foam-party-tickets-980c1",
      storageBucket: "foam-party-tickets-980c1.firebasestorage.app",
      messagingSenderId: "65345044953",
      appId: "1:65345044953:web:fb02ce3901f9d4e684d9c8"
    };

    // Инициализация Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Инициализация статичных лимитов (ты будешь обновлять их вручную)
    const initialTicketLimits = {
      "Порту": { standard: 30, standardPlus: 20, family: 20, total: 70 },
      "Лиссабон": { standard: 40, standardPlus: 30, family: 30, total: 100 },
      "Алгарве": { standard: 60, standardPlus: 40, family: 0, total: 100 }
    };

    function initializeTicketLimits() {
      const ticketLimitsRef = db.ref('ticketLimits');
      ticketLimitsRef.once('value', (snapshot) => {
        if (!snapshot.exists()) {
          ticketLimitsRef.set(initialTicketLimits);
        }
      });
    }

    function updateDates() {
      const city = document.getElementById("city").value;
      const dateSelect = document.getElementById("eventDate");
      const dateSection = document.getElementById("dateSection");

      dateSelect.innerHTML = "";

      if (!city) {
        dateSection.style.display = "none";
        return;
      }

      let dates = [];
      if (city === "Порту") {
        dates = ["2025-08-23", "2025-08-24"];
      } else if (city === "Алгарве") {
        dates = ["2025-08-28"];
      } else if (city === "Лиссабон") {
        dates = ["2025-08-30"];
      }

      dates.forEach(date => {
        const option = document.createElement("option");
        option.value = date;
        option.text = new Date(date).toLocaleDateString("ru-RU");
        dateSelect.appendChild(option);
      });

      dateSection.style.display = "block";
    }

    function updateTicketInfo() {
      const ticketType = document.querySelector('input[name="ticketType"]:checked')?.value;
      const city = document.getElementById("city").value;
      const quantitySection = document.getElementById("quantitySection");
      const paymentButtons = document.getElementById("paymentButtons");
      const stripeButtonContainer = document.getElementById("stripeButtonContainer");
      const cryptoPaymentContainer = document.getElementById("cryptoPaymentContainer");
      const payFiat = document.getElementById("payFiat");
      const payCrypto = document.getElementById("payCrypto");
      const outOfStockMessage = document.getElementById("outOfStockMessage");

      if (ticketType && city) {
        quantitySection.style.display = "block";
        paymentButtons.style.display = "block";
        stripeButtonContainer.style.display = "none";
        cryptoPaymentContainer.style.display = "none";
        showAddress();
        updateAvailability(city, ticketType);
        const ticketLimitsRef = db.ref(`ticketLimits/${city}`);
        ticketLimitsRef.once('value', (snapshot) => {
          const limits = snapshot.val() || initialTicketLimits[city];
          const available = limits ? limits[ticketType] : 0;
          payFiat.disabled = !available || available <= 0;
          payCrypto.disabled = !available || available <= 0;
          outOfStockMessage.style.display = !available || available <= 0 ? "block" : "none";
        });
      } else {
        quantitySection.style.display = "none";
        paymentButtons.style.display = "none";
        stripeButtonContainer.style.display = "none";
        cryptoPaymentContainer.style.display = "none";
        payFiat.disabled = true;
        payCrypto.disabled = true;
        outOfStockMessage.style.display = "none";
      }
    }

    function updateAvailability(city, ticketType) {
      const ticketQuantity = parseInt(document.getElementById("ticketQuantity").value);
      const ticketAvailability = document.getElementById("ticketAvailability");

      if (ticketType && city) {
        const ticketLimitsRef = db.ref(`ticketLimits/${city}`);
        ticketLimitsRef.once('value', (snapshot) => {
          const limits = snapshot.val() || initialTicketLimits[city];
          const available = limits ? limits[ticketType] : 0;
          if (ticketQuantity <= available) {
            ticketAvailability.innerText = `Доступно: ${available} билетов.`;
          } else {
            ticketAvailability.innerText = `Недостаточно билетов. Доступно: ${available}.`;
          }
        }).catch((error) => {
          console.error("Ошибка при загрузке данных:", error);
          ticketAvailability.innerText = "Ошибка загрузки данных.";
        });
      }
    }

    function showAddress() {
      const city = document.getElementById("city").value;
      const addressText = {
        "Порту": "R. do Cerro 396, 4405-736 Vila Nova de Gaia",
        "Лиссабон": "Praia de Carcavelos, Лиссабон",
        "Алгарве": "Praia da Rocha, Алгарве"
      };
      const mapLinks = {
        "Порту": "https://maps.app.goo.gl/qwegq9geA1fnfzcT8",
        "Лиссабон": "https://maps.google.com/?q=Praia+de+Carcavelos+Lisboa",
        "Алгарве": "https://maps.google.com/?q=Praia+da+Rocha+Algarve"
      };

      const addressSection = document.getElementById("addressSection");
      if (city) {
        document.getElementById("addressText").innerText = addressText[city];
        document.getElementById("mapLink").href = mapLinks[city];
        addressSection.style.display = "block";
      } else {
        addressSection.style.display = "none";
      }
    }

    function showStripePayment() {
      const ticketType = document.querySelector('input[name="ticketType"]:checked')?.value;
      const ticketQuantity = parseInt(document.getElementById("ticketQuantity").value);
      const city = document.getElementById("city").value;
      const stripeButtonContainer = document.getElementById("stripeButtonContainer");
      const cryptoPaymentContainer = document.getElementById("cryptoPaymentContainer");

      if (!ticketType || !ticketQuantity || !city) {
        alert("Выберите тип, количество билетов и город!");
        return;
      }

      stripeButtonContainer.innerHTML = '';
      cryptoPaymentContainer.style.display = 'none';

      let buyButtonId;
      if (ticketType === "standard") {
        buyButtonId = "buy_btn_1RbU8NLWvpIFJx0GGgRmvdc1";
      } else if (ticketType === "standardPlus") {
        buyButtonId = "buy_btn_1RbaacLWvpIFJx0GW7dM1vJQ";
      } else if (ticketType === "family") {
        buyButtonId = "buy_btn_1RbcbtLWvpIFJx0GPWou4ymy";
      }

      if (!buyButtonId) {
        console.error("Не найден buyButtonId для типа билета:", ticketType);
        return;
      }

      const stripeButton = document.createElement('stripe-buy-button');
      stripeButton.setAttribute('buy-button-id', buyButtonId);
      stripeButton.setAttribute('publishable-key', 'pk_live_51RahBHLWvpIFJx0GgW5tZ173sGzJgcZXUJVmecoqEKxrzxGLp9EpqhK64wXFUGYXjU2sxCuddytGRsWOf0sgagr700HovZduI6');
      stripeButtonContainer.appendChild(stripeButton);
      stripeButtonContainer.style.display = 'block';

      // Отправляем уведомление администратору без изменения счетчика
      sendAdminNotification(city, ticketType, ticketQuantity);

      console.log("Stripe button added with buyButtonId:", buyButtonId);
    }

    function showCryptoPayment() {
      const ticketType = document.querySelector('input[name="ticketType"]:checked')?.value;
      const city = document.getElementById("city").value;
      const cryptoPaymentContainer = document.getElementById("cryptoPaymentContainer");
      const stripeButtonContainer = document.getElementById("stripeButtonContainer");

      if (!ticketType || !city) {
        alert("Выберите тип билета и город!");
        return;
      }

      cryptoPaymentContainer.innerHTML = '';
      stripeButtonContainer.style.display = 'none';

      let paymentLink;
      if (ticketType === "standard") {
        if (city === "Порту") paymentLink = "https://nowpayments.io/payment/?iid=4948781828&source=button";
        else if (city === "Лиссабон") paymentLink = "https://nowpayments.io/payment/?iid=4948781828&source=button";
        else if (city === "Алгарве") paymentLink = "https://nowpayments.io/payment/?iid=4948781828&source=button";
      } else if (ticketType === "standardPlus") {
        if (city === "Порту") paymentLink = "https://nowpayments.io/payment/?iid=5115039554&source=button";
        else if (city === "Лиссабон") paymentLink = "https://nowpayments.io/payment/?iid=5115039554&source=button";
        else if (city === "Алгарве") paymentLink = "https://nowpayments.io/payment/?iid=5115039554&source=button";
      } else if (ticketType === "family") {
        if (city === "Порту") paymentLink = "https://nowpayments.io/payment/?iid=6307653663&source=button";
        else if (city === "Лиссабон") paymentLink = "https://nowpayments.io/payment/?iid=6307653663&source=button";
        else if (city === "Алгарве") paymentLink = "https://nowpayments.io/payment/?iid=6307653663&source=button";
      }

      const cryptoButton = document.createElement('a');
      cryptoButton.href = paymentLink;
      cryptoButton.target = "_blank";
      cryptoButton.rel = "noreferrer noopener";
      const img = document.createElement('img');
      img.src = "https://nowpayments.io/images/embeds/payment-button-white.svg";
      img.alt = "Cryptocurrency & Bitcoin payment button by NOWPayments";
      cryptoButton.appendChild(img);
      cryptoPaymentContainer.appendChild(cryptoButton);
      cryptoPaymentContainer.style.display = 'block';

      // Отправляем уведомление администратору без изменения счетчика
      sendAdminNotification(city, ticketType, 1);

      console.log("Crypto button added with paymentLink:", paymentLink);
    }

    function sendAdminNotification(city, ticketType, quantity) {
      const email = "твой_адрес_почты@example.com"; // Замени на свой email
      const subject = "Новая попытка покупки билета";
      const body = `Новая попытка покупки:\nГород: ${city}\nТип билета: ${ticketType}\nКоличество: ${quantity}\nПожалуйста, проверь оплату и обнови лимиты вручную.`;

      // Используем EmailJS для отправки email
      emailjs.send("service_id", "template_id", {
        to_email: email,
        subject: subject,
        message: body
      }).then(() => {
        console.log("Уведомление отправлено");
      }, (error) => {
        console.error("Ошибка отправки уведомления:", error);
      });
    }

    function showAddress() {
      const city = document.getElementById("city").value;
      const addressText = {
        "Порту": "R. do Cerro 396, 4405-736 Vila Nova de Gaia",
        "Лиссабон": "Praia de Carcavelos, Лиссабон",
        "Алгарве": "Praia da Rocha, Алгарве"
      };
      const mapLinks = {
        "Порту": "https://maps.app.goo.gl/qwegq9geA1fnfzcT8",
        "Лиссабон": "https://maps.google.com/?q=Praia+de+Carcavelos+Lisboa",
        "Алгарве": "https://maps.google.com/?q=Praia+da+Rocha+Algarve"
      };

      const addressSection = document.getElementById("addressSection");
      if (city) {
        document.getElementById("addressText").innerText = addressText[city];
        document.getElementById("mapLink").href = mapLinks[city];
        addressSection.style.display = "block";
      } else {
        addressSection.style.display = "none";
      }
    }

    // Инициализация EmailJS
    (function() {
      emailjs.init("твой_public_key"); // Замени на свой public key от EmailJS
    })();

    // Инициализация при загрузке
    initializeTicketLimits();
  </script>
</body>
</html>